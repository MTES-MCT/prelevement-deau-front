import {useState} from 'react'

import {AccountCircle, ExpandMore} from '@mui/icons-material'
import {
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Box,
  Chip,
  Divider,
  Grid2,
  Typography,
  useTheme,
  useMediaQuery
} from '@mui/material'
import {orderBy} from 'lodash-es'

import Document from '@/components/document.js'
import Regles from '@/components/regles.js'

const statuts = {
  'En activité': 'primary',
  Terminée: 'success',
  Abandonnée: 'error',
  'non renseigné': ''
}

const LabelValue = ({label, value}) => {
  if (value) {
    return (
      <Box>
        <b>{label} : </b>
        <i>{value}</i>
      </Box>
    )
  }
}

const PointExploitations = ({pointPrelevement}) => {
  const theme = useTheme()
  const isSmallScreen = useMediaQuery(theme.breakpoints.down('sm'))
  const [expanded, setExpanded] = useState(false)
  const orderedExploitations = pointPrelevement.exploitations.sort((a, b) => {
    if (a.date_fin === undefined) {
      return -1
    }

    if (b.date_fin === undefined) {
      return 1
    }

    return b.id_exploitation - a.id_exploitation
  })
  const handleChange = panel => (event, isExpanded) => {
    setExpanded(isExpanded ? panel : false)
  }

  return (
    <Box
      sx={{
        m: isSmallScreen ? 0 : 2,
        p: isSmallScreen ? 0 : 3
      }}
    >
      {orderedExploitations.map(exploitation => {
        const documents = exploitation.documents.map(document => ({
          ...document,
          dateSignature: new Date(document.date_signature)
        }))
        const orderedDocuments = orderBy(documents, ['dateSignature'], ['desc'])
        return (
          <Accordion
            key={exploitation.id_exploitation}
            expanded={expanded === exploitation.id_exploitation}
            onChange={handleChange(exploitation.id_exploitation)}
          >
            <AccordionSummary expandIcon={<ExpandMore />}>
              <Box
                sx={{
                  display: 'flex',
                  gap: isSmallScreen ? 1 : 5,
                  flexDirection: isSmallScreen ? 'column' : 'row',
                  justifyContent: 'space-between',
                  alignItems: isSmallScreen ? 'start' : 'center',
                  width: '100%'
                }}
              >
                <Box sx={{flex: 1, display: 'flex', gap: 1}}>
                  <AccountCircle />
                  <Typography sx={{pr: 5}}>
                    <b>{
                      exploitation.beneficiaire.nom
                        || exploitation.beneficiaire.raison_sociale
                        || exploitation.beneficiaire.sigle
                    }</b>
                  </Typography>
                </Box>
                <Box sx={{
                  flex: 1,
                  display: 'flex',
                  gap: 2,
                  pr: isSmallScreen ? 0 : 3,
                  flexDirection: isSmallScreen ? 'column' : 'row',
                  justifyContent: 'end',
                  alignItems: isSmallScreen ? 'start' : 'center'
                }}
                >
                  <b>#{exploitation.id_exploitation}</b>
                  <Typography sx={{px: isSmallScreen ? 0 : 2}}>
                    <i>({exploitation.date_debut} / {exploitation.date_fin || 'en cours '})</i>
                  </Typography>
                  <Chip label={exploitation.statut} color={statuts[exploitation.statut]} />
                </Box>
              </Box>
            </AccordionSummary>
            <AccordionDetails>
              <Grid2
                container
                sx={{
                  gap: 2,
                  justifyContent: 'space-between'
                }}
              >
                <LabelValue label='Statut' value={exploitation.statut} />
                <LabelValue label='Usage' value={exploitation.usage} />
                <LabelValue label='Date de début' value={exploitation.date_debut} />
                <LabelValue label='Date de fin' value={exploitation.date_fin} />
                <LabelValue label='Raison abandon' value={exploitation.raison_abandon} />
                <LabelValue label='Remarque' value={exploitation.remarque} />
              </Grid2>
              <Grid2>
                <Divider sx={{m: 2}} textAlign='left'>
                  Documents
                </Divider>
                {orderedDocuments.map(document => (
                  <Document key={document.id_document} document={document} />
                ))}
              </Grid2>
              <Grid2>
                <Divider sx={{m: 2}} textAlign='left'>
                  Règles
                </Divider>
                {exploitation.regles.length > 0 ? (
                  <Regles regles={exploitation.regles} />
                ) : (
                  <Typography>Aucune règle</Typography>
                )}
              </Grid2>
            </AccordionDetails>
          </Accordion>
        )
      })}
    </Box>
  )
}

export default PointExploitations
