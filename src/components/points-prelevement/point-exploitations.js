'use client'

import {useState} from 'react'

import {AccountCircle, ExpandMore} from '@mui/icons-material'
import {
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Chip,
  Divider,
  Grid2,
  Typography
} from '@mui/material'
import {orderBy} from 'lodash-es'

import Document from '@/components/document.js'
import Regles from '@/components/regles.js'

const statuts = {
  'En activité': 'primary',
  Terminée: 'success',
  Abandonnée: 'error',
  'non renseigné': ''
}

const LabelValue = ({label, value}) => {
  if (value) {
    return (
      <div>
        <b>{label} : </b>
        <i>{value}</i>
      </div>
    )
  }
}

const PointExploitations = ({pointPrelevement}) => {
  const [expanded, setExpanded] = useState(false)
  const orderedExploitations = pointPrelevement.exploitations.sort((a, b) => {
    if (a.date_fin === undefined) {
      return -1
    }

    if (b.date_fin === undefined) {
      return 1
    }

    return b.id_exploitation - a.id_exploitation
  })

  const handleChange = panel => (event, isExpanded) => {
    setExpanded(isExpanded ? panel : false)
  }

  return (
    <div className='m-0 p-0 sm:m-2 sm:p-3'>
      {orderedExploitations.map(exploitation => {
        const documents = exploitation.documents.map(document => ({
          ...document,
          dateSignature: new Date(document.date_signature)
        }))
        const orderedDocuments = orderBy(documents, ['dateSignature'], ['desc'])
        return (
          <Accordion
            key={exploitation.id_exploitation}
            expanded={expanded === exploitation.id_exploitation}
            onChange={handleChange(exploitation.id_exploitation)}
          >
            <AccordionSummary expandIcon={<ExpandMore />}>
              <div className='flex gap-1 sm:gap-5 flex-col sm:flex-row justify-between items-start sm:items-center w-full'>
                <div className='flex-1 flex gap-1'>
                  <AccountCircle />
                  <Typography className='pr-5'>
                    <b>
                      {exploitation.beneficiaire.nom
                        || exploitation.beneficiaire.raison_sociale
                        || exploitation.beneficiaire.sigle}
                    </b>
                  </Typography>
                </div>
                <div className='flex-1 flex gap-2 pr-0 sm:pr-3 flex-col sm:flex-row justify-end items-start sm:items-center'>
                  <b>#{exploitation.id_exploitation}</b>
                  <Typography className='px-0 sm:px-2'>
                    <i>
                      ({exploitation.date_debut} / {exploitation.date_fin || 'en cours '})
                    </i>
                  </Typography>
                  <Chip label={exploitation.statut} color={statuts[exploitation.statut]} />
                </div>
              </div>
            </AccordionSummary>
            <AccordionDetails>
              <Grid2
                container
                sx={{
                  gap: 2,
                  justifyContent: 'space-between'
                }}
              >
                <LabelValue label='Statut' value={exploitation.statut} />
                <LabelValue label='Usage' value={exploitation.usage} />
                <LabelValue label='Date de début' value={exploitation.date_debut} />
                <LabelValue label='Date de fin' value={exploitation.date_fin} />
                <LabelValue label='Raison abandon' value={exploitation.raison_abandon} />
                <LabelValue label='Remarque' value={exploitation.remarque} />
              </Grid2>
              <Grid2>
                <Divider sx={{m: 2}} textAlign='left'>
                  Documents
                </Divider>
                {orderedDocuments.map(document => (
                  <Document key={document.id_document} document={document} />
                ))}
              </Grid2>
              <Grid2>
                <Divider sx={{m: 2}} textAlign='left'>
                  Règles
                </Divider>
                {exploitation.regles.length > 0 ? (
                  <Regles regles={exploitation.regles} />
                ) : (
                  <Typography>Aucune règle</Typography>
                )}
              </Grid2>
            </AccordionDetails>
          </Accordion>
        )
      })}
    </div>
  )
}

export default PointExploitations
