import ExpandMoreIcon from '@mui/icons-material/ExpandMore'
import {
  Box,
  Typography,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Chip
} from '@mui/material'

import formatDate from '@/lib/format-date.js'

const statuts = {
  'En activité': 'primary',
  Terminée: 'success',
  Abandonnée: 'error',
  'non renseigné': ''
}

const findPreleveurName = (id, preleveurs) => {
  const preleveur = preleveurs?.find(b => b.id_preleveur === id)
  if (!preleveur) {
    return 'Préleveur inconnu'
  }

  return preleveur.raison_sociale || preleveur.sigle || `${preleveur.nom} ${preleveur.prenom}`
}

const ExploitationAccordion = ({exploitation, preleveurs}) => {
  const preleveur = findPreleveurName(exploitation.id_preleveur, preleveurs)
  const dateLabel = `${formatDate(exploitation.date_debut) || '???'} - ${formatDate(exploitation.date_fin) || 'en cours'}`

  return (
    <Accordion sx={{mt: 1}}>
      <AccordionSummary expandIcon={<ExpandMoreIcon />}>
        <Box>
          <Typography fontWeight='bold'>
            Exploitation #{exploitation.id_exploitation}
          </Typography>
          <Typography variant='body2'>{dateLabel}</Typography>
        </Box>
      </AccordionSummary>
      <AccordionDetails>
        <Typography>
          <strong>Préleveur :</strong> {preleveur}
        </Typography>
        {exploitation.usages.length > 0 && (
          <Typography>
            <strong>Usages :</strong> {exploitation.usages.join(', ')}
          </Typography>
        )}
        {exploitation.statut && (
          <Box className='flex items-center gap-2'>
            <Typography>
              <strong>Statut :</strong>
            </Typography>
            <Chip label={exploitation.statut} color={statuts[exploitation.statut]} />
          </Box>
        )}
      </AccordionDetails>
    </Accordion>
  )
}

export default ExploitationAccordion
