import {useState, useEffect} from 'react'

import ExpandMoreIcon from '@mui/icons-material/ExpandMore'
import {
  Accordion, AccordionDetails, AccordionSummary, Typography, Box, Divider
} from '@mui/material'

import {getStatutColors} from './legend-colors.js'

import {getPointPrelevement} from '@/app/api/points-prelevement.js'
import Document from '@/components/document.js'
import Regles from '@/components/regles.js'

function isOver(dateFin) {
  if (!dateFin) {
    return false
  }

  const today = new Date()
  const dateFinObj = new Date(dateFin)

  return dateFinObj < today
}

const ExploitationListItem = ({exploitation}) => {
  const [pointName, setPointName] = useState()

  useEffect(() => {
    const fetchPointsPrelevement = async () => {
      const point = await getPointPrelevement(exploitation.id_point)
      setPointName(point.nom)
    }

    if (exploitation?.id_point) {
      fetchPointsPrelevement()
    }
  }, [exploitation])

  return (
    <Accordion>
      <AccordionSummary expandIcon={<ExpandMoreIcon />}>
        <Box sx={{
          width: '100%', display: 'flex', justifyContent: 'space-between', marginRight: 2
        }}
        >
          <Box sx={{
            width: '100%', display: 'flex', gap: 2, alignItems: 'center'
          }}
          >
            <Typography>{pointName}</Typography>
            <Typography fontWeight='light' fontStyle='italic' className='fr-text--sm'>{`(${exploitation.date_debut} - ${isOver(exploitation.date_fin) ? exploitation.date_fin : 'en cours'})`}</Typography>
          </Box>

          <p
            className='fr-badge fr-badge--sm'
            style={{
              backgroundColor: getStatutColors(exploitation.statut)?.color,
              color: getStatutColors(exploitation.statut)?.textColor
            }}
          >{exploitation.statut}</p>
        </Box>
      </AccordionSummary>

      <AccordionDetails>
        <Box>
          <Divider sx={{mt: 4}} textAlign='left'>Documents</Divider>
          {exploitation.documents.map(document => <Document key={document.id_document} document={document} />)}
        </Box>

        <Box>
          <Divider sx={{mt: 4}} textAlign='left'>RÃ¨gles</Divider>
          <Regles regles={exploitation.regles} documents={exploitation.documents} />
        </Box>

      </AccordionDetails>
    </Accordion>
  )
}

export default ExploitationListItem
