'use client'

import {useState, useEffect, useMemo} from 'react'

import {Box} from '@mui/material'

import Modalite from '@/components/modalite.js'
import Regles from '@/components/regles.js'

const statuts = {
  1: 'En activité',
  2: 'terminée',
  3: 'abandonnée',
  4: 'non renseigné'
}

const usages = {
  1: 'Eau potable',
  2: 'Agriculture',
  3: 'Autre',
  4: 'Camion citerne',
  5: 'Eau embouteillée',
  6: 'Hydroélectricité',
  7: 'Industrie',
  8: 'Non renseigné',
  9: 'Thermalisme'
}

const Exploitation = ({exploitation, beneficiaires}) => {
  const [beneficiaire, setBeneficiaire] = useState(null)
  const [orderedRegles, setOrderedRegles] = useState(null)
  const regles = useMemo(() => exploitation?.regles || [], [exploitation?.regles])
  const modalites = useMemo(() => exploitation?.modalites || [], [exploitation?.modalites])

  useEffect(() => {
    if (beneficiaires && exploitation && regles) {
      setBeneficiaire(beneficiaires.find(
        beneficiaire => beneficiaire.id_beneficiaire === exploitation.id_beneficiaire
      ))

      setOrderedRegles(regles.sort((a, b) => new Date(a.date_debut) - new Date(b.date_debut)))
    }
  }, [beneficiaires, exploitation, regles])

  return (
    <>
      <Box sx={{pb: 2}}>
        {beneficiaire && regles && (
          <>
            <Box><b>Statut :</b> {statuts[exploitation.statut] || <i>Non renseigné</i>}</Box>
            <div><b>Usage : </b> {usages[exploitation.usage] || <i>Non renseigné</i>}</div>
            <Box><b>Date de début :</b> {exploitation.date_debut || <i>Non renseigné</i>}</Box>
            <Box><b>Date de fin :</b> {exploitation.date_fin || <i>Non renseigné</i>}</Box>
            <Box><b>Raison abandon :</b> {exploitation.raison_abandon || <i>Non renseigné</i>}</Box>
            <Box><b>Remarque :</b> {exploitation.remarque || <i>Non renseigné</i>}</Box>
            <Box><b>Bénéficiaire :</b> {beneficiaire?.sigle || beneficiaire?.raison_sociale}</Box>
            <Box>
              <b>Règles : </b>
              {regles.length > 0 ? (
                <Regles
                  regles={orderedRegles}
                />
              ) : (
                <i>Pas de règles</i>
              )}
            </Box>
            <Box>
              <b>Modalités : </b>
              {modalites.length > 0
                ? modalites.map(modalite => (
                  <Modalite
                    key={modalite.id_modalite}
                    modalite={modalite}
                  />
                )) : (
                  <i>Pas de modalités</i>
                )}
            </Box>
          </>
        )}
      </Box>
      <hr />
    </>
  )
}

export default Exploitation
