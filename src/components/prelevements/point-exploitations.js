'use client'

import {useEffect, useState} from 'react'

import {AccountCircle, ExpandMore} from '@mui/icons-material'
import {
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Alert,
  Chip,
  Divider,
  Grid2,
  Typography
} from '@mui/material'
import {orderBy} from 'lodash-es'

import {getVolumesExploitation} from '@/app/api/points-prelevement.js'
import Document from '@/components/document.js'
import VolumesChart from '@/components/prelevements/volumes-chart.js'
import Regles from '@/components/regles.js'
import formatDate from '@/lib/format-date.js'

const statuts = {
  'En activité': 'primary',
  Terminée: 'success',
  Abandonnée: 'error',
  'non renseigné': ''
}

const LabelValue = ({label, value}) => {
  if (value) {
    return (
      <div>
        <b>{label} : </b>
        <i>{value}</i>
      </div>
    )
  }
}

const PointExploitations = ({pointPrelevement}) => {
  const [expanded, setExpanded] = useState(false)
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState(null)
  const [exploitationsWithVolumes, setExploitationsWithVolumes] = useState([])
  const orderedExploitations = pointPrelevement.exploitations.sort((a, b) => {
    if (a.date_fin === undefined) {
      return -1
    }

    if (b.date_fin === undefined) {
      return 1
    }

    return b.id_exploitation - a.id_exploitation
  })

  const handleChange = panel => (event, isExpanded) => {
    setExpanded(isExpanded ? panel : false)
  }

  useEffect(() => {
    async function getVolumes() {
      try {
        setIsLoading(true)
        const promises = orderedExploitations.map(async exploitation => {
          const volumes = await getVolumesExploitation(exploitation.id_exploitation)
          return {...exploitation, volumes}
        })

        const exploitationsWithVolumes = await Promise.all(promises)
        const orderedExploitationsWithVolumes = exploitationsWithVolumes.sort((a, b) => {
          if (a.statut === 'En activité' && b.statut !== 'En activité') {
            return -1
          }

          if (a.statut !== 'En activité' && b.statut === 'En activité') {
            return 1
          }

          return 0
        })
        setExploitationsWithVolumes(orderedExploitationsWithVolumes)
        setIsLoading(false)
      } catch (error) {
        console.error(error)
        setError(error)
      }
    }

    getVolumes()
  }, [orderedExploitations])

  return (
    <div className='m-0 p-0 sm:m-2 sm:p-3'>
      {exploitationsWithVolumes.length > 0 && exploitationsWithVolumes.map(exploitation => {
        const documents = exploitation.documents.map(document => ({
          ...document,
          dateSignature: new Date(document.date_signature)
        }))
        const orderedDocuments = orderBy(documents, ['dateSignature'], ['desc'])
        const {volumes} = exploitation

        return (
          <Accordion
            key={exploitation.id_exploitation}
            expanded={expanded === exploitation.id_exploitation}
            onChange={handleChange(exploitation.id_exploitation)}
          >
            <AccordionSummary expandIcon={<ExpandMore />}>
              <div className='flex gap-1 sm:gap-5 flex-col sm:flex-row justify-between items-start sm:items-center w-full'>
                <div className='flex-1 flex gap-1'>
                  <AccountCircle />
                  <Typography className='px-2'>
                    <b>
                      {exploitation.beneficiaire.nom
                        || exploitation.beneficiaire.raison_sociale
                        || exploitation.beneficiaire.sigle}
                    </b>
                  </Typography>
                  ({exploitation.usages.join(', ')})
                </div>
                <div className='flex-1 flex gap-2 pr-0 sm:pr-3 flex-col sm:flex-row justify-end items-start sm:items-center'>
                  <Typography className='px-0 sm:px-2'>
                    <i>
                      ({formatDate(exploitation.date_debut)} - {formatDate(exploitation.date_fin) || 'en cours '})
                    </i>
                  </Typography>
                  <Chip label={exploitation.statut} color={statuts[exploitation.statut]} />
                </div>
              </div>
            </AccordionSummary>
            <AccordionDetails>
              {error && (
                <Alert severity='error'>{error}</Alert>
              )}
              {volumes.valeurs.length > 0 && (
                <VolumesChart volumes={volumes} isLoading={isLoading} />
              )}
              <Grid2
                container
                sx={{
                  gap: 2,
                  justifyContent: 'space-between'
                }}
              >
                <LabelValue label='Raison abandon' value={exploitation.raison_abandon} />
                <LabelValue label='Remarque' value={exploitation.remarque} />
              </Grid2>
              <Grid2>
                <Divider sx={{m: 2}} textAlign='left'>
                  Documents
                </Divider>
                {orderedDocuments.map(document => (
                  <Document key={document.id_document} document={document} />
                ))}
              </Grid2>
              <Grid2>
                <Divider sx={{m: 2}} textAlign='left'>
                  Règles
                </Divider>
                {exploitation.regles.length > 0 ? (
                  <Regles regles={exploitation.regles} />
                ) : (
                  <Typography>Aucune règle</Typography>
                )}
              </Grid2>
            </AccordionDetails>
          </Accordion>
        )
      })}
    </div>
  )
}

export default PointExploitations
