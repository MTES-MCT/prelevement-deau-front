import {useState} from 'react'

import ExpandMoreIcon from '@mui/icons-material/ExpandMore'
import {
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Box,
  Divider,
  Grid2,
  Typography
} from '@mui/material'
import {orderBy} from 'lodash-es'

import Document from '@/components/document.js'

const LabelValue = ({label, value}) => {
  if (value) {
    return (
      <Box>
        <b>{label} : </b>
        <i>{value}</i>
      </Box>
    )
  }
}

const PointExploitations = ({pointPrelevement}) => {
  const [expanded, setExpanded] = useState(false)
  const handleChange = panel => (event, isExpanded) => {
    setExpanded(isExpanded ? panel : false)
  }

  const orderedExploitations = pointPrelevement.exploitations.sort((a, b) => b.id_exploitation - a.id_exploitation)

  return (
    <Box
      sx={{
        m: 2,
        p: 3
      }}
    >
      {orderedExploitations.map(exploitation => {
        const documents = exploitation.documents.map(document => ({
          ...document,
          dateSignature: new Date(document.date_signature)
        }))
        const orderedDocuments = orderBy(documents, ['dateSignature'], ['desc'])
        return (
          <Accordion
            key={exploitation.id_exploitation}
            expanded={expanded === exploitation.id_exploitation}
            onChange={handleChange(exploitation.id_exploitation)}
          >
            <AccordionSummary expandIcon={<ExpandMoreIcon />}>
              <Typography>Exploitation #{exploitation.id_exploitation}</Typography>
            </AccordionSummary>
            <AccordionDetails>
              <Grid2
                container
                sx={{
                  gap: 2,
                  justifyContent: 'space-between'
                }}
              >
                <LabelValue label='Statut' value={exploitation.statut} />
                <LabelValue label='Usage' value={exploitation.usage} />
                <LabelValue label='Date de dÃ©but' value={exploitation.date_debut} />
                <LabelValue label='Date de fin' value={exploitation.date_fin} />
                <LabelValue label='Raison abandon' value={exploitation.raison_abandon} />
                <LabelValue label='Remarque' value={exploitation.remarque} />
              </Grid2>
              <Grid2>
                <Divider sx={{m: 2}} textAlign='left'>
                  Documents
                </Divider>
                {orderedDocuments.map(document => (
                  <Document key={document.id_document} document={document} />
                ))}
              </Grid2>
            </AccordionDetails>
          </Accordion>
        )
      })}
    </Box>
  )
}

export default PointExploitations
